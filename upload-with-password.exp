#!/usr/bin/expect -f

# Automated upload with password authentication
set timeout -1

set SERVER_IP "72.60.222.97"
set SERVER_USER "root"
set PASSWORD "lWV,S'8A+&grKvQlQ,7E"
set DEST_PATH "/root/bimsync-portal"

# Colors
proc green {text} { return "\033\[0;32m$text\033\[0m" }
proc yellow {text} { return "\033\[1;33m$text\033\[0m" }
proc blue {text} { return "\033\[0;34m$text\033\[0m" }

puts [blue "ğŸš€ BIMSync Portal - Auto Upload to Server"]
puts "========================================"
puts ""
puts "ğŸ“‹ Configuration:"
puts "  Server: $SERVER_USER@$SERVER_IP"
puts "  Destination: $DEST_PATH"
puts ""

puts "ğŸ“¦ Creating archive..."
exec tar --exclude='node_modules' \
    --exclude='.next' \
    --exclude='.git' \
    --exclude='*.log' \
    --exclude='.env.local' \
    --exclude='dist' \
    --exclude='build' \
    --exclude='.DS_Store' \
    --exclude='bimsync-upload.tar.gz' \
    --exclude='*.tar.gz' \
    -czf "bimsync-upload.tar.gz" .

puts [green "âœ… Archive created"]
puts ""
puts "ğŸ“¤ Uploading to server..."

# SCP with password
spawn scp -o StrictHostKeyChecking=no bimsync-upload.tar.gz $SERVER_USER@$SERVER_IP:/tmp/
expect {
    "password:" {
        send "$PASSWORD\r"
        expect eof
    }
    eof
}

puts [green "âœ… Upload successful"]
puts ""
puts "ğŸ“‚ Extracting on server..."

# SSH and extract
spawn ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP
expect "password:"
send "$PASSWORD\r"
expect "#"

send "mkdir -p $DEST_PATH\r"
expect "#"

send "if \[ -f $DEST_PATH/package.json \]; then mv $DEST_PATH $DEST_PATH.backup.\$(date +%Y%m%d-%H%M%S); mkdir -p $DEST_PATH; fi\r"
expect "#"

send "tar -xzf /tmp/bimsync-upload.tar.gz -C $DEST_PATH\r"
expect "#"

send "rm /tmp/bimsync-upload.tar.gz\r"
expect "#"

send "echo ''\r"
send "echo 'Files in $DEST_PATH:'\r"
send "ls -la $DEST_PATH | head -n 20\r"
expect "#"

send "exit\r"
expect eof

puts ""
puts [green "âœ… Extraction successful"]

# Clean up local archive
exec rm bimsync-upload.tar.gz

puts ""
puts [green "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"]
puts [green "ğŸ‰ Upload Complete!"]
puts [green "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"]
puts ""
puts [blue "ğŸ“‹ Next Steps:"]
puts ""
puts "1ï¸âƒ£  SSH to your server:"
puts [yellow "   ssh $SERVER_USER@$SERVER_IP"]
puts "   Password: $PASSWORD"
puts ""
puts "2ï¸âƒ£  Build Docker image:"
puts [yellow "   cd $DEST_PATH"]
puts [yellow "   docker build -t bimsync-portal:latest ."]
puts ""
puts "3ï¸âƒ£  Deploy in Coolify Dashboard"
puts ""
